<html>
<head>
<title>/draw</title>
<!--[if IE]>
  <script src="http://html5shiv.googlecode.com/svn/trunk/html5.js"></script>
<![endif]-->
<link rel="shortcut icon" href="/favicon.png" />
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black">
<meta name="apple-mobile-web-app-title" content="/draw">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0, user-scalable=no">
<script src="https://code.jquery.com/jquery-2.1.1.min.js"></script>
<style>
html,body{
	font-family: "HelveticaNeue-Light", "Helvetica Neue Light", "Helvetica Neue", Helvetica, Arial, "Lucida Grande", sans-serif; 
	font-weight: 300;
	width:      100%;
    height:     100%;
    overflow:   hidden;
}
#chat_toggle:hover{
	cursor: pointer;
}

body > canvas {
    height:     100%;
    overflow:   scroll;
}

button {
    background:#555;
    color:white;
    border:1px solid black;
    padding:5px;
}

button:hover{
    cursor:pointer;
}

.faded{
	opacity: 0;
	-webkit-transition:opacity 700ms ease,height 300ms ease 700ms;
	-moz-transition:opacity 700ms ease,height 300ms ease 700ms;
}

#alert_div_container{
    text-align:center;
    width:100%;
    position:absolute;
    top:10px;
    z-index:10;
}

#alert_div{
    display:inline-block;
    background:#555;
    color:white;
    padding:5px;
    border: 1px solid black;
}

#corner{
    position:absolute;
    top:10px;
    right:10px;
    background:#555;
    color:white;
    padding:5px;
    -moz-user-select: none;
    -khtml-user-select: none;
    -webkit-user-select: none;
    -o-user-select: none;z-index:9;
    text-align:center;
    border: 1px solid black;
}

#corner a{
    color:white;
}

#colorwheel{
    position:absolute;
    display:none;
    background:#555;
}

#chat{
    position:absolute;
    bottom:0;
    right:0;
    width:250px;
    background:white;
    border-left: 1px solid black;
    border-top: 1px solid black;
    padding:0;
    margin:0;
}

#chat_header {
    background-color:#555;
    color:#fff;
    height:27px;
    line-height:27px;
    padding-left:5px;
    padding-right:5px;
}
#chat_header:hover{
    cursor:pointer
}

#chat .input{
    position:absolute;
    bottom:0;
    height:27px;
    width:100%;
    padding:0;
    margin:0;
    border:none;
    border-top: 1px solid black;
    resize: none;
}

#chat .body {
    overflow:scroll;
    position:absolute;
    top:27px;
    bottom:27px;
    left:0;
    right:0;
    overflow-x:hidden;
    word-wrap: break-word;
}

.chat{
    padding:2px;
}
.chat:nth-child(even) {background: #CCC}
.chat:nth-child(odd) {background: #FFF}

.chat_shown {
    position:absolute;
    bottom:0;
    right:0;
    top:50%;
}

.chat_time {
    font-size:12px;
    font-style:italic;
    padding: 0 5px;
    float:right;
}

.chat_hash {
	font-size:10px;
    font-style:italic;
}

.chat_hash:hover{
	cursor:pointer;
}

.hidden{
	display:none;
}

#chat_body {
    top: 27px;
}

.chat_button{
	margin-top:5px;
	width:16px;
}

.minimap{
    position:absolute;
    bottom:0;
    left:0;
    display:none;
}

</style>
<link rel="icon" type="image/png" href="static/images/draw-favicon.png">
<script src="http://bwasti.com:5000/socket.io/socket.io.js"></script>
<script>

/* globals */
var mouse_coords = {};
var displacement = {x:0, y:0};
var max_length = 5000;
var socket;
var redraw_interval = 1000;
var redraw_counter = 0;
var image = new Image();
var image_size = 200.0;
var max = {height:2000, width:3000};
var backCanvas = document.createElement('canvas');
backCanvas.width = max.width;
backCanvas.height = max.height;
var backCtx = backCanvas.getContext('2d');
var quota = 8000;
var max_quota = 8000;
var quota_interval = 100;
var curr_downkey = '';
var start_colors = "FRBGYPQNOU";
var curr_color = start_colors[Math.floor(Math.random()*start_colors.length)-1];
var curr_stroke = "normal";
var cR = '0';
var cG = '0';
var cB = '0';
var special_names = ["RPG", "furguy", "shitstorm", "emgram"];
var name = "Anon";
var password = "";

function hex_to_rgb(hex) {
    var result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
    return result ? {
        r: parseInt(result[1], 16),
        g: parseInt(result[2], 16),
        b: parseInt(result[3], 16)
    } : null;
}

function draw_pt(ctx, p, callback) {
	var x1 = ctx === backCtx ? p.prevX - displacement.x : p.prevX;
	var y1 = ctx === backCtx ? p.prevY - displacement.y : p.prevY;
	var x2 = ctx === backCtx ? p.currX - displacement.x : p.currX;
	var y2 = ctx === backCtx ? p.currY - displacement.y : p.currY;
	var stroke_type = p.stroke_type ? p.stroke_type : "normal";
	
	var r = p.r ? p.r : '0';
	var g = p.g ? p.g : '0';
    var b = p.b ? p.b : '0';
	ctx.strokeStyle = "rgba("+r+", "+g+", "+b+", 1.0)";
	ctx.lineJoin = ctx.lineCap = 'round';
	
	switch (stroke_type) {
		case "3dim":
			ctx.lineWidth = 2;
			for (var i = 0; i < 8; i++){
				ctx.beginPath();
				ctx.strokeStyle = "rgba("+r+", "+g+", "+b+", "+(1.0-0.1*i)+")";
			    ctx.moveTo(x1+i, y1+i);
			    ctx.lineTo(x2+i, y2+i);
			    ctx.stroke();
			}
		case "normal":
		default:
			ctx.beginPath();
		    ctx.lineWidth = 4;
			ctx.moveTo(x1, y1);
			ctx.lineTo(x2, y2);
			ctx.stroke();
   			break;
	}


    ctx.closePath();
	if (callback) callback(p, x1,y1,r,g,b,x2,y2,stroke_type);
}

function draw_file(file, type, x, y) {
return;
	var elem;
	if (["gif", "jpg", "jpeg", "png"].indexOf(type) > -1) {
		elem = document.createElement("img");
	} else if (["webm", "ogv"].indexOf(type) > -1) {
		elem = document.createElement("video");
		elem.onmouseover = function(){this.play();}
		elem.onmouseout = function(){this.pause();}
	} else {
		return;
	}
	elem.src = "/tmp/uploads/"+file+"."+type;
	elem.style.position = "absolute";
	elem.style.top = y;
	elem.style.left = x;
	elem.style.maxWidth = "200px";
	elem.style.maxHeight = "200px";
	elem.style.zIndex = "99999";
	document.body.appendChild(elem);

	return;
}

function draw_char(ctx, c, callback) {
	var x = ctx === backCtx ? c.currTextX - displacement.x : c.currTextX;
	var y = ctx === backCtx ? c.currTextY - displacement.y : c.currTextY;

	var supported_types = ["gif", "jpg", "jpeg", "png", "webm", "ogv"];
	if (c && c.c)
    	var file_test = c.c.match(/embed:([a-z0-9\-]+).([a-z]+)/);
    else
    	return;
    if (file_test){
		if (file_test[1] && file_test[2] && !(ctx === backCtx)){
			if (supported_types.indexOf(file_test[2])>-1) {
				draw_file(file_test[1], file_test[2], x, y);
				return;				
			}

		}
    }
    
    var text_width = c.c.length * 14.45;
	ctx.fillStyle = "#FFFFFF";
	ctx.fillRect(x, y+5, text_width, -23);
	ctx.font = '12pt Courier';
    ctx.fillStyle = 'black';

    if (c.c[0] == ">")
    	ctx.fillStyle = 'green';
    ctx.fillText(c.c, x, y);

	if (callback) callback(c, x,y);
}

function draw_image(ctx, image_data, callback) {
	var load_image = new Image();
	var x = ctx === backCtx ? image_data.x - displacement.x : image_data.x;
	var y = ctx === backCtx ? image_data.y - displacement.y : image_data.y;
    load_image.onload = function(){
    	var scale_factor = load_image.height > load_image.width ? image_size/load_image.height : image_size/load_image.width;
		ctx.drawImage(load_image, x, y,
	  				scale_factor*load_image.width,
	  				scale_factor*load_image.height);  
	  	if (callback) callback(image_data, x,y);
    };
	load_image.src = image_data.src;
}

function cast_vote(clear_val) {
	if (have_voted)
		return;
	var vote_data = {
		type:"vote",
		clear:clear_val
	};
	socket.emit('client', [vote_data]);
	vote += clear_val;
	update_clear();
	have_voted = true;
	return;
}

var send_interval = 10;
var last_image = 0;

function update_quota(){
	var base_width = 100.0;
	var width = base_width*quota/max_quota;
	width = width < 0 ? 0 : width;
	var height = 20;
	var canvas = document.getElementById("main_canvas");
	var context = canvas.getContext("2d");
	context.fillStyle = 'white';
	context.fillRect(10, 10, base_width, height);
	context.fillStyle = 'green';
	context.fillRect(10, 10, width, height);
	//document.getElementById("quota").style.width = 1.0*quota/max_quota+"%";
	return;
}

var vote = 0;
var max_vote = 20;
var user_count = 0;
var have_voted = false;

function update_clear(){
	var base_width = 100.0;
	var width = (base_width*vote)/(max_vote*2);
	width = width > (base_width/2) ? base_width/2 : width;
	width = width < -(base_width/2) ? -(base_width/2) : width;
	var height = 10;
	var canvas = document.getElementById("main_canvas");
	var context = canvas.getContext("2d");
	context.fillStyle = 'white';
	context.fillRect(10, 35, base_width, height);
	context.fillStyle = 'rgb(221, 0, 0)';
	context.fillRect(60, 35, width, height);

}

function quota_loop(){
	quota = quota+20 >= max_quota ? max_quota : quota+20;
	update_quota();
}

function push_element(element, x, y, r, g, b, x2, y2, stroke_type) {
	var send_obj = {
		type: element.type
	}
	switch (send_obj.type) {
		case "word":
			send_obj.currTextX = x;
			send_obj.currTextY = y;
			send_obj.c = element.c;
			break;
		case "stroke":
			quota -= 1*(Math.abs(x2-x)+Math.abs(y2-y));
			send_obj.prevX = x;
			send_obj.prevY = y;
			send_obj.currX = x2;
			send_obj.currY = y2;
			send_obj.r = r;
			send_obj.g = g;
			send_obj.b = b;
			send_obj.stroke_type = stroke_type;
			break;
		case "image":
			quota -= 4000;
			send_obj.x = x;
			send_obj.y = y;
			send_obj.src = element.src;
			break;
        case "chat":
			quota -= 1000;
            send_obj.body = element.body;
            send_obj.name = element.name;
            send_obj.password = element.password;
		    socket.emit('client', [send_obj]);
            return;
	}
	if (quota <= 0) {
		quota -= 50;
		update_quota();
		return;
	}
	update_quota();
	to_send.push(send_obj);
	if (to_send.length >= send_interval || element.type == "word" || element.type == "image"){
		socket.emit('client', to_send);
		delete to_send;
		to_send = [];
	}
}

function draw_canvas(canvas){
	var c = canvas;
	var ctx = c.getContext("2d");
	ctx.clearRect ( 0 , 0 , canvas.width , canvas.height );

	/* background */
	ctx.fillStyle = "#FFFFFF";
	ctx.fillRect(0,0,c.width,c.height);
	
	/* saved canvas */
	ctx.drawImage(backCanvas, displacement.x, displacement.y);
	update_quota();
	update_clear();
}

var flag = false,
    prevX = 0,
    currX = 0,
    prevY = 0,
    currY = 0,
    prevScrollX = 0,
    prevScrollY = 0,
    currScrollX = 0,
    currScrollY = 0,
    currTextX = 0,
    currTextY = 0,
    dot_flag = false;

function handle_mouse(canvas, evt) {
    var rect = canvas.getBoundingClientRect();
    mouse_coords = {
      x: evt.clientX - rect.left,
      y: evt.clientY - rect.top
    };
    ctx = canvas.getContext("2d");

    ctx.beginPath();
    ctx.moveTo(prevX, prevY);
    ctx.lineTo(currX, currY);
    ctx.strokeStyle = x;
    ctx.lineWidth = y;
    ctx.stroke();
    ctx.closePath();

    return;
}

function send_chat(){
    if ($("#chat_input").val().trim() == '')
        return;
    if ($("#chat_input").val() == '/color')
    {
        cR = prompt("Custom red value:");
        cG = prompt("Custom green value:");
        cB = prompt("Custom blue value:");
        alert("You can now use the custom key D for your color");
        curr_downkey = 'D';
        $("#chat_input").val("");
        return;
    }
    if ($("#chat_input").val().slice(0,5) == '/help') {
        notifier("<b>Drawing:</b><br>\
        The canvas clears when over 50% of users have voted clear<br>\
        To change colors hold letters while drawing.<br> \
        To set a custom color type /color in the chat. This will \
        be mapped to the key D.<br>\
        To insert an image into the canvas, drag a saved image\
        from your computer (not a webpage).<br><br>\
        <b>Chat:</b><br>\
        To set your name type /name <name> in the chat<br> \
        To insert an image into the chat use the markup:\
        [img src=\"IMAGEURL\"]<br>\
        To insert a link into the chat use the markup:\
        [link src=\"URL\"]<br>\
        To insert a video into the chat use the markup:\
        [video src=\"VIDEOURL\"]<br>\
        To insert an iframe link into the chat,\
        which will popup when clicked:\
        [embed src=\"IFRAMEURL\"]<br><br>\
        ", 10000);
        $("#chat_input").val("");
        return;
    }
    if ($("#chat_input").val().slice(0,6) == '/name ')
    {
        if ($("#chat_input").val().match(/\/name\ (.+)/).length > 1){
            name = $("#chat_input").val().match(/\/name\ (.+)/)[1];
            if (localStorage)
                localStorage.name = name;
        }
        $("#chat_input").val("");
        return;
    }
    if ($("#chat_input").val().slice(0,7) == '/clear ')
    {
        if ($("#chat_input").val().match(/\/clear\ (.+)/).length > 1){
            var clear_password = $("#chat_input").val().match(/\/clear\ (.+)/)[1];
            send_force_clear(clear_password);
        }
        $("#chat_input").val("");
        return;
    }
    if ($("#chat_input").val().slice(0,7) == '/admin ')
    {
        if ($("#chat_input").val().match(/\/admin\ (.+)/).length > 1){
            password = $("#chat_input").val().match(/\/admin\ (.+)/)[1];
            $(".chat_hash").toggleClass("hidden");
            $('#chat_body').scrollTop($('#chat_body')[0].scrollHeight);
        }
        $("#chat_input").val("");
        return;
    }
    if ($("#chat_input").val().slice(0,6) == '/mute ')
    {
        if ($("#chat_input").val().match(/\/mute\ (.+)/).length > 1){
            var hash = $("#chat_input").val().match(/\/mute\ (.+)/)[1];
            send_set_quota(hash, -8000);
        }
        $("#chat_input").val("");
        return;
    }
    if ($("#chat_input").val().slice(0,10) == '/password ')
    {
        if ($("#chat_input").val().match(/\/password\ (.+)/).length > 1){
            password = $("#chat_input").val().match(/\/password\ (.+)/)[1];
            if (localStorage)
                localStorage.password = password;
        }
        $("#chat_input").val("");
        return;
    }
    if ($("#chat_input").val().slice(0,1) == '/') {
    	$("#chat_input").val("");
        return;
	}
    var text = $("#chat_input").val();
    if (name.trim() == '')
        name = "Anon";
    var element = {
        type: 'chat',
        name: name,
        body: text,
        password: password
    }
    add_to_chat(element);
    push_element(element);
    $("#chat_input").val("");
    return false;
}
 
var counter = 0;
var to_send = [];
var word_obj = {};
var said_once = [];
var unread_chats = 0;
var window_focus = true;
var click_count = 0;

$(window)
    .focus(function () {
        window_focus = true;
        window.document.title = "/draw";
        if (!$('#chat_body').is(':hidden')) {
            unread_chats = 0;
        }
    })
    .blur(function () {
        window_focus = false;
    });

function add_to_chat(data){
    var text = data.body;
    if (text == '') return;
    var name = data.name;
    if (!data.time) data.time = new Date();
    var time = new Date(data.time);
    if($('#chat_body').is(':hidden') || !window_focus) {
        unread_chats++;
    }
    if($('#chat_body').is(':hidden')) {
        $("#chat_header div:first").text("Chat ("+unread_chats+")");
    }
    if(!window_focus) {
        window.document.title = "/draw ("+unread_chats+")";
    }

    var new_chat = $("<div>");
    var new_name = $("<span>");
    var new_time = $("<span>");
    var new_hash = $("<span>");

    new_chat.toggleClass("chat");
    new_chat.text(text);
   
    new_time.toggleClass("chat_time");
    new_time.text(time.toLocaleTimeString());

	new_hash.toggleClass("chat_hash");
	new_hash.toggleClass("hidden");
	if (data.hash)
    	new_hash.html("<a onclick='send_set_quota(\""+data.hash+"\", -8000);'>mute</a>");
    else
    	new_hash.text("me");
	new_hash.append($("<br>"));

    if (name == 'admin') {
        new_name.css({color:"red"});
    }

    if (special_names.indexOf(name) > -1) {
        new_name.css({color:"blue"});
    }

    if (name[0] == '>') {
        new_name.css({color:"green"});
        name = name.slice(1);
    }

    new_name.text(name);
    new_name.css({fontWeight:"bold", paddingRight:"2px"});

    new_chat.prepend($("<br>"));
    new_chat.prepend(new_time);
    new_chat.prepend(new_name);
    new_chat.prepend(new_hash);

    new_chat.html(new_chat.html().replace(/(\[img src=\"(\S+)\"\])/g,
        '<a href="$2" target="_blank"><img src="$2" style="max-width:100%;"/></a>'));
    new_chat.html(new_chat.html().replace(/(\[video src=\"(\S+)\"\])/g,
        '<a href="$2" target="_blank"><video src="$2" style="max-width:100%;" controls/></a>'));
    new_chat.html(new_chat.html().replace(/(\[embed src=\"(\S+)\"\])/g,
        '<button onclick=\'launch_iframe("$2")\'>embed link <br>"$2"</button>'));
    $("#chat_body").append(new_chat);
    new_chat.html(new_chat.html().replace(/(\[link src=\"(\S+)\"\])/g, '<a href="$2" target="_blank">"$2"</a>'));
    setTimeout(function(){
        $('#chat_body').scrollTop($('#chat_body')[0].scrollHeight);
    }, 200);
    return;
}

function launch_iframe(url){
    var new_frame_container = $("<div>");
    var new_frame_close_button = $("<a><img width='16px' style='padding-bottom:5px;' src='static/images/draw/close_chat.png'></a>");
    new_frame_close_button.click(function(){
        new_frame_container.remove();
    });
    var new_frame = $("<iframe>");
    new_frame.attr("src", url);
    new_frame.css({
        border:"none",
        resize:"both",
        overflow:"auto !important"
        });
    new_frame_container.css({
        position:"absolute",
        top:"80px",
        left:0,
        background:"#555",
        padding:"5px"
    });
    new_frame_close_button.css({
    });
    new_frame_container.drags();
    new_frame_container.append(new_frame_close_button);
    new_frame_container.append($("<br>"));
    new_frame_container.append(new_frame);
    
    $("body").append(new_frame_container);
}

(function($) {
    $.fn.drags = function(opt) {

        opt = $.extend({handle:"",cursor:"pointer"}, opt);

        if(opt.handle === "") {
            var $el = this;
        } else {
            var $el = this.find(opt.handle);
        }

        return $el.css('cursor', opt.cursor).on("mousedown", function(e) {
            if(opt.handle === "") {
                var $drag = $(this).addClass('draggable');
            } else {
                var $drag = $(this).addClass('active-handle').parent().addClass('draggable');
            }
            var z_idx = $drag.css('z-index'),
                drg_h = $drag.outerHeight(),
                drg_w = $drag.outerWidth(),
                pos_y = $drag.offset().top + drg_h - e.pageY,
                pos_x = $drag.offset().left + drg_w - e.pageX;
            $drag.css('z-index', 1000).parents().on("mousemove", function(e) {
                $('.draggable').offset({
                    top:e.pageY + pos_y - drg_h,
                    left:e.pageX + pos_x - drg_w
                }).on("mouseup", function() {
                    $(this).removeClass('draggable').css('z-index', z_idx);
                });
            });
            e.preventDefault(); // disable selection
        }).on("mouseup", function() {
            if(opt.handle === "") {
                $(this).removeClass('draggable');
            } else {
                $(this).removeClass('active-handle').parent().removeClass('draggable');
            }
        });

    }
})(jQuery);

function draw_remote(element) {
	ctx = document.getElementById("main_canvas").getContext("2d");
	switch (element.type) {
		case "word":
			element.currTextX += displacement.x;
			element.currTextY += displacement.y;
			draw_char(ctx, element);
			draw_char(backCtx, element);
			break;
		case "stroke":
			element.prevX += displacement.x;
			element.prevY += displacement.y;
			element.currX += displacement.x;
			element.currY += displacement.y;
			draw_pt(ctx, element);
			draw_pt(backCtx, element);
			break;
		case "image":
			element.x += displacement.x;
			element.y += displacement.y;
			draw_image(ctx, element);
			draw_image(backCtx, element);
			break;
		case "vote":
			vote+=-1+2*(element.clear > 0);
			update_clear();
			break;
		case "init_vote":
			vote = element.clear;
			have_voted = false;
			update_clear();
			break;
        case "init_chat":
            for (var i in element.chat) {
                add_to_chat(element.chat[i]);
            }
            break;
		case "clear_screen":
			ctx.fillStyle = "white";
			ctx.fillRect(0,0,window.innerWidth,window.innerHeight);
			backCtx.fillStyle = "white";
			backCtx.fillRect(0,0,backCanvas.width, backCanvas.height);
			break;
		case "user_count":
			user_count = element.count;
			max_vote = Math.floor(0.6*user_count);
			update_clear();
			document.getElementById("user_count").textContent = element.count;
			break;
        case "chat":
            add_to_chat(element);
            break;
		case "notification":
			notifier(element.message, element.length);
			break;
	}
	return;
}

function draw_to_binary(){
		var randomX = Math.floor(Math.random()*window.innerWidth);
		var randomY = Math.floor(Math.random()*window.innerHeight);
		var clearBlock = {
			type:"word",
			currTextX:randomX,
			currTextY:randomY,
			c:"  "
		}
		draw_char(ctx, clearBlock);
		/*var canvas = document.getElementById('main_canvas');
		backCtx.fillStyle = "rgba(255,255,255,"+0.005+")";
		backCtx.fillRect(0, 0, backCanvas.width, backCanvas.height);
		ctx.fillStyle = "rgba(255,255,255,"+0.005+")";
		ctx.fillRect(0, 0, canvas.width, canvas.height);
		//draw_canvas(canvas);*/
}

//setInterval(draw_to_binary, 100);

var chat_count = 0;
var old_chat_count = 0;
var chat_counter_interval;
/* keeps count of the chats seen and not seen
   to alert on new chat */
function chat_counter(){
	if (document.getElementById("chat_frame") && document.getElementById("chat_frame").contentWindow
		&& document.getElementById("chat_frame").contentWindow.chat) {
		chat_count = Object.keys(document.getElementById("chat_frame").contentWindow.chat).length;
	}
	var new_chats = chat_count - old_chat_count;
	if (new_chats > 0) document.getElementById("chat_button").innerHTML = "&#x25B2; chat ("+new_chats+")";
}

var chat_open = false;
var chat_loaded = false;

function toggle_chat() {
    if ($('#chat_body').is(':hidden')) {
        unread_chats = 0;
        $("#chat_header div:first").text("Chat");
        $('#chat_body').show();
        $('#chat_input').show();
        $('#chat_toggle').html('<img class="chat_button" src="static/images/draw/close_chat.png"/>');
        $('#chat').addClass('chat_shown');
        $('#chat_body').scrollTop($('#chat_body')[0].scrollHeight);
    } else {
        $('#chat_body').hide();
        $('#chat_input').hide();
        $('#chat_toggle').html('<img class="chat_button" src="static/images/draw/open_chat.png"/>');
        $('#chat').removeClass('chat_shown');
    }
}

function notifier(message, length) {
	if (message == "forcerefreshall") {
	    location.reload();
		return;
	}

 	var loading_div = document.getElementById("alert_div");
 	loading_div.innerHTML = message;
 	loading_div.classList.toggle("faded");
 	document.getElementById("alert_div_container").style.display = "block";
	setTimeout(function(){
		loading_div.classList.toggle("faded");
		setTimeout(function(){
			loading_div.innerHTML = "";
			document.getElementById("alert_div_container").style.display = "none";
		},750);
	},length);
}

function send_notification(message, length, password){
	var send_obj = {
		type:"notification",
		password:password,
		message:message,
		length:length
	};
	socket.emit('client', [send_obj]);
}

function send_force_clear(password){
	var send_obj = {
		type:"force_clear",
		password:password
	};
	socket.emit('client', [send_obj]);
}

function send_set_quota(hash, quota){
	var send_obj = {
		type:"set_quota",
		password:password,
		hash:hash,
		quota:quota
	};
	socket.emit('client', [send_obj]);
}

var rainbow = 0;
var can_type = true;
var loaded_files = [];
var port = 5000;

window.addEventListener('load', function(){
	var path = window.location.pathname.match(/\/([a-z0-9]+)/);
	if (path && path.length && path[1]) {
		if (path[1] == "draw") {
			initial_load();
		} else if (path[1] == "draw2") {
			window.title = '/draw2';
			document.write("sorry, draw2 was shutdown");
		}
	}
},false);

function animate_to_middle(canvas){
	var destx = Math.floor(Math.random()*canvas.width);
	var desty = Math.floor(Math.random()*canvas.height);
	var scale = 1.0*desty/destx;
	for (var i=0; i<destx; i+=10){
		(function(j){
			setTimeout(function(){
				displacement.y = -scale*j;
				displacement.x = -j;
				draw_canvas(canvas);
			}, j);
		})(i);
	}
}

function display_color_wheel(x,y){
    $("#colorwheel").css({
        left:x,
        top:y,
        display:"block"
    });
}

function choose_custom_color(){
    var new_color = hex_to_rgb($("#colorselect").val());
    if (new_color){
        cR = new_color.r;
        cG = new_color.g;
        cB = new_color.b;
        curr_downkey = 'D';
    }
    $("#colorwheel").hide();
}

function initial_load(){
    if (localStorage) {
        if (localStorage.name)
            name = localStorage.name;
        if (localStorage.password)
            password = localStorage.password;
        if (localStorage.quota)
            quota = localStorage.quota;
    }
    if ((localStorage && localStorage.isEighteen) ||
        confirm("Please confirm that you are over 18 to enter this section of the site.")) {
        localStorage.isEighteen = true;
    } else {
        window.location.href = "/";
        return;
    }
	var canvas = document.getElementById('main_canvas'),
        context = canvas.getContext('2d');

	function resize_canvas() {
        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;
        draw_canvas(canvas);
	}
	
	function handlefocus(e){
	  if(e.type=='mouseover'){
	    canvas.focus();
	    document.getElementById("main_text_input").value = '';
	    document.getElementById("main_text_input").focus();
	    return false;
	  }else if(e.type=='mouseout'){
	    canvas.blur();
	    return false;
	  }
	  return true;
	};
	
    function findxy(res, e) {
		currTextX = e.clientX - canvas.offsetLeft;
		currTextY = e.clientY - canvas.offsetTop;
	    if (res == 'down') {
            can_type = false;
	    	document.getElementById("main_text_input").value = '';

	        prevX = currX;
	        prevY = currY;
	        currX = e.clientX - canvas.offsetLeft;
	        currY = e.clientY - canvas.offsetTop;
	
	        flag = true;
			if (curr_downkey !== '')
				process_key();
	        dot_flag = true;
	        if (dot_flag) {
	       		click_count++;
	        	if (click_count > 1) {
	        		click_count = 0;
                    display_color_wheel(currX, currY);
					flag = true;
					if (curr_downkey === '')
						can_type = true;
	        	}
	            ctx.beginPath();
				ctx.fillStyle = "rgba(0,0,0,0.5)";
	            ctx.fillRect(currX, currY, 2, 2);
	            ctx.closePath();
	            dot_flag = false;

	        } else {
		        click_count = 0;
	        }
	    }
	    if (res == 'up' || res == "out") {
	        flag = false;
			if (curr_downkey === '')
				can_type = true;
	    }
	    if (res == 'move') {
	    	click_count = 0;

	    	var localCurrX, localCurrY;
	    	if (e.targetTouches && e.targetTouches.length == 1) {
			    var touch = e.targetTouches[0];
			    // Place element where the finger is
			    localCurrX = touch.pageX;
			    localCurrY = touch.pageY;
			} else if (e.targetTouches && e.targetTouches.length == 2) {
				prevScrollX = currScrollX;
				prevScrollY = currScrollY;
				
			    currScrollX = (e.targetTouches[0].pageX + e.targetTouches[1].pageX)/2;
			    currScrollY = (e.targetTouches[0].pageY + e.targetTouches[1].pageY)/2;
			    
			    
			    var wheelDeltaX = Math.floor(-(currScrollX - prevScrollX)),
			    	wheelDeltaY =  Math.floor(-(currScrollY - prevScrollY));

				wheelDeltaX = wheelDeltaX == 0 ? 1 : wheelDeltaX;
				wheelDeltaY = wheelDeltaY == 0 ? 1 : wheelDeltaY;
				if (prevScrollX+prevScrollY == 0)
					return;
			    mouseWheelHandler({
				    wheelDeltaX: wheelDeltaX,
				    wheelDeltaY: wheelDeltaY
			    });
			} else {
            	localCurrX = e.clientX - canvas.offsetLeft;
				localCurrY = e.clientY - canvas.offsetTop;
            }
            
            $("#sprite").css({
	            top:localCurrY-25+"px",
	            left:localCurrX-25+"px"
            });
			
    		if (document.getElementById("main_text_input").value != ''
    			&& (Math.abs(prevX - localCurrX)+Math.abs(prevY - localCurrY)) > 100) {
    				if (said_once.indexOf(word_obj.c) < 0){
				        draw_char(context, word_obj);
						draw_char(backCtx, word_obj, push_element);
						if (!(/^\s*$/.test(word_obj.c))){
							said_once.push(word_obj.c);
						}
    				}
    
					document.getElementById("main_text_input").value = '';
    		}

	        if (flag) {
	            prevX = currX;
	            prevY = currY;
	            currX = localCurrX;
	            currY = localCurrY;
		        /*if (e.targetTouches && e.targetTouches.length == 1) {
				    var touch = e.targetTouches[0];
				    // Place element where the finger is
				    currX = touch.pageX;
				    currY = touch.pageY;
				} else if (e.targetTouches && e.targetTouches.length == 2) {
					prevScrollX = currScrollX;
					prevScrollY = currScrollY;
					
				    currScrollX = (e.targetTouches[0].pageX + e.targetTouches[1].pageX)/2;
				    currScrollY = (e.targetTouches[0].pageY + e.targetTouches[1].pageY)/2;
				    
				    
				    var wheelDeltaX = Math.floor(-(currScrollX - prevScrollX)),
				    	wheelDeltaY =  Math.floor(-(currScrollY - prevScrollY));

					wheelDeltaX = wheelDeltaX == 0 ? 1 : wheelDeltaX;
					wheelDeltaY = wheelDeltaY == 0 ? 1 : wheelDeltaY;
					if (prevScrollX+prevScrollY == 0)
						return;
				    mouseWheelHandler({
					    wheelDeltaX: wheelDeltaX,
					    wheelDeltaY: wheelDeltaY
				    });
				} else {
	            	currX = e.clientX - canvas.offsetLeft;
					currY = e.clientY - canvas.offsetTop;
	            }*/

	            if(quota-Math.abs(currX-prevX)+Math.abs(currY-prevY) >= 0)
	            	draw_stroke();
	        }
	    }
	}
	
	ctx = context;
	function draw_stroke() {
		var r = '0';
		var g = '0';
		var b = '0';
		switch(curr_color){
			case 'F':
				break;
			case 'B':
				b = '255';
				break;
			case 'N':
				r = 63;
				g = 173;
				b = 233;
				break;
			case 'O':
				r = '255';
				g = '165';
				break;
			case 'R':
				r = '255';
				break;
			case 'G':
				g = '255';
				break;
			case 'Y':
				r = '255';
				g = '255';
				break;
            case 'S':
                r = '239';
                g = '208';
                b = '207';
                break;
			case 'P':
				r = '255';
				g = '170';
				b = '170';
				break;
			case 'W':
				r = '255';
				g = '255';
				b = '255';
				break;
			case 'Q':
				r = '100';
				g = '12';
				b = '170';
				break;
            case 'C':
                r = '100';
                g = '100';
                b = '100';
                break;
            case 'J':
                r = '139';
                g = '69';
                b = '19';
                break;
            case 'D':
                r = cR;
                g = cG;
                b = cB;
                break;
			case 'U':
				r = Math.floor(Math.sin(rainbow)*127+128)+'';
				g = Math.floor(Math.sin(rainbow+2)*127+128)+'';
				b = Math.floor(Math.sin(rainbow+4)*127+128)+'';
				rainbow = (rainbow+1)%100;
				break;
			default:
				break;
		}
		//document.getElementById("main_text_input") = '';
		var stroke_obj = {
					prevX:prevX,
					prevY:prevY,
					currX:currX,
					currY:currY,
					strokeStyle:"rgba(0, 0, 0, 0.3)",
					lineWidth:4,
					type:"stroke",
					r:r, g:g, b:b,
					stroke_type: curr_stroke
		};
		draw_pt(context, stroke_obj);
		draw_pt(backCtx, stroke_obj, push_element);
	}

	function draw_words(e) {
		if (quota - 110 < 0) return;
	   	var text_area = document.getElementById("main_text_input");
	   	text_area.value = text_area.value.slice(0,40);
        var text_width = text_area.value.length * 14.45;
		if (word_obj) delete word_obj;
        word_obj = {
        	c: text_area.value,
        	currTextX: currTextX,
        	currTextY: currTextY,
			type:"word"
        };
        
		quota -= 110;
		update_quota();
		draw_char(context, word_obj);
		draw_char(backCtx, word_obj);

	}

    window.addEventListener('resize', resize_canvas, false);


	function mouseWheelHandler(e) {
		if (document.getElementById("main_text_input").value != '') {
    				if (said_once.indexOf(word_obj.c) < 0){
				        draw_char(context, word_obj);
						draw_char(backCtx, word_obj, push_element);
						said_once.push(word_obj.c);
    				}
    
					document.getElementById("main_text_input").value = '';
    		}
		var scroll_speed = 10;
		if (e.preventDefault)
			e.preventDefault();
	    document.getElementById("main_text_input").value = '';
	    if (!e.wheelDeltaX) {
		    e.wheelDeltaX = -e.deltaX;
		    e.wheelDeltaY = -e.deltaY;
	    }
	    if (Math.abs(e.wheelDeltaX + e.wheelDeltaY) < 20) {
		    e.wheelDeltaX *= 4;
		    e.wheelDeltaY *= 4;
	    }
	    if (Math.abs(e.wheelDeltaX + e.wheelDeltaY) > 400) {
		    return;
	    }
	    displacement.x = displacement.x + e.wheelDeltaX;
		displacement.y = displacement.y + e.wheelDeltaY;
		displacement.y = displacement.y - window.innerHeight <= -max.height ? -max.height + window.innerHeight : displacement.y;
		displacement.x = displacement.x - window.innerWidth <= -max.width ? -max.width + window.innerWidth : displacement.x;
		displacement.y = displacement.y >= 0 ? 0 : displacement.y;
		displacement.x = displacement.x >= 0 ? 0 : displacement.x;
		draw_canvas(canvas);		
	}

	canvas.addEventListener("wheel", mouseWheelHandler, false);
	canvas.addEventListener("mousewheel", mouseWheelHandler, false);


	canvas.addEventListener("mousemove", function (e) {
        findxy('move', e);
    }, false);
    canvas.addEventListener("mousedown", function (e) {
        findxy('down', e);
    }, false);
    canvas.addEventListener("mouseup", function (e) {
        findxy('up', e);
    }, false);
    
    canvas.addEventListener("touchmove", function (e) {
    	e.preventDefault();
        findxy('move', e);
    }, false);
    canvas.addEventListener("touchstart", function (e) {
        findxy('down', e);
    }, false);
    canvas.addEventListener("touchend", function (e) {
	    currScrollX = 0;
	    currScrollY = 0;
        findxy('up', e);
    }, false);
    
    canvas.addEventListener("mouseout", function (e) {
        findxy('out', e);
        handlefocus(e);
    }, false);
    canvas.addEventListener("mouseover", function (e) {
        handlefocus(e);
    }, false);

	function process_key() {
		if ("ABCDEFGHIJKLMNOPQRSTUVWXYZ".indexOf(curr_downkey) >= 0)
			curr_color = curr_downkey;
	}


    document.body.addEventListener("keydown", function (e) {
		if (!e)
			e = window.event;
		var code = e.keyCode;
		if (e.charCode && code == 0)
			code = e.charCode;
		var scroll_speed = 20;
		//console.log(e)
		if (code < 200) { // fucking os x...
			curr_downkey = String.fromCharCode(code);
			if (flag)
				process_key();
		}
		switch(code) {
			case 16:
				curr_stroke = "3dim";
				break;
			case 37:
			// Key left.
				document.getElementById("main_text_input").value = '';
				displacement.x = displacement.x >= 0 ? displacement.x : displacement.x+scroll_speed;
				draw_canvas(canvas);
				break;
			case 38:
			// Key up.
				document.getElementById("main_text_input").value = '';
				displacement.y = displacement.y >= 0 ? displacement.y : displacement.y+scroll_speed;
				draw_canvas(canvas);
				break;
			case 39:
			// Key right.
				document.getElementById("main_text_input").value = '';
				displacement.x = displacement.x - window.innerWidth <= -max.width ? displacement.x : displacement.x-scroll_speed;
				draw_canvas(canvas);
				break;
			case 40:
			// Key down.
				document.getElementById("main_text_input").value = '';
				displacement.y = displacement.y - window.innerHeight <= -max.height ? displacement.y : displacement.y-scroll_speed;
				draw_canvas(canvas);
				break;
			default:
				document.getElementById("main_text_input").focus();
		}
		return false;
    }, false);


    document.getElementById('chat_input').addEventListener("keydown", function(e) {
        var code = (e.keyCode ? e.keyCode : e.which);
        if(code == 13) { //Enter keycode
            e.preventDefault();
            send_chat();
        }
        e.stopPropagation();
    });
    document.getElementById('chat_input').addEventListener("keyup", function(e) {
        e.stopPropagation();
    });

	document.body.addEventListener("keyup", function (e) {
		curr_stroke = "normal";

		curr_downkey = '';
		if (!can_type) {
			document.getElementById("main_text_input").value = '';
			if (!flag) can_type = true;
			return;
		}
		if (!e)
				e = window.event;
		var code = e.keyCode;
		if (e.charCode && code == 0)
			code = e.charCode;
		switch(code) {
			case 37:
			case 38:
			case 39:
			case 40:
				return;
			default:
				break;
		}

        draw_words(e);
		return false;
    }, false);
	document.ondragover = function () { this.className = 'hover'; return false; };
	document.ondragend = function () { this.className = ''; return false; };
	document.ondrop = function (e) {
	  e.preventDefault();

	  var file = e.dataTransfer.files[0],
	      reader = new FileReader();
	  if (!file)
	  	file = e.originalEvent.dataTransfer.files[0];
	  reader.onloadend = function (event) {
			console.log(e);
			/*holder.style.background = 'url(' + event.target.result + ') no-repeat center';*/
			var img = new Image;
			img.onload = function() {
				var resizeCanvas = document.createElement("canvas");
				var scale_factor = img.height > img.width ? image_size/img.height : image_size/img.width;
				resizeCanvas.width = scale_factor*img.width;
				resizeCanvas.height = scale_factor*img.height;
				var resizeCtx = resizeCanvas.getContext("2d");
				//resizeCtx.scale(scale_factor, scale_factor);
				resizeCtx.clearRect(0,0, resizeCanvas.width, resizeCanvas.height);
				resizeCtx.drawImage(img, 0, 0, scale_factor*img.width, scale_factor*img.height);
				var compressedSrc = resizeCanvas.toDataURL('image/png');
				//console.log(compressedSrc);
				if ("data:," === compressedSrc)
					compressedSrc = img.src;

				var image_data = {
					type: "image",
					x: e.pageX,
					y: e.pageY,
					src: compressedSrc
				};
				if (quota > 4000){
					draw_image(ctx, image_data);
	                if (loaded_files.indexOf(file.name)<0) {
					    draw_image(backCtx, image_data, push_element);
                    }
					loaded_files.push(file.name);
				} else {
					return;
				}
			};
			img.src = event.target.result;
	  };
	  console.log(file);
	  reader.readAsDataURL(file);
	
	  return false;
	};

    resize_canvas();
    socket = io.connect(location.protocol+'//'+location.hostname+':'+port+'/', {secure: (location.protocol === "https:")});
	var load_buffer = []; /* don't display until the background is loaded */
	var loaded = false;
	socket.on('server', function (data) {
		if (data.length){
			for (i in data) {
				if (loaded)
					draw_remote(data[i]);
				else
					load_buffer.push(data[i]);
			}
		}
	  });
	  
	  
	  /*
	 socket.on('init_draw', function (data) { 
		image.onload = function() {
		    backCtx.drawImage(image, 0, 0);
		    draw_canvas(canvas);
		};
		image.src = data.image;
	 });
	 */
 	var loading_div = document.getElementById("alert_div");
 	loading_div.innerHTML = "Loading...";
 	//document.body.appendChild(loading_div);
 	image.src = "/draw.jpg";

	image.onload = function() {
		loading_div.innerHTML = "Type /help into chat to learn how to use /draw.";
		setTimeout(function(){
			loading_div.classList.toggle("faded");
			setTimeout(function(){
				loading_div.innerHTML = "";
				document.getElementById("alert_div_container").style.display = "none";
			},750);
			//loading_div.innerHTML = "";
		},3500);
		backCtx.drawImage(image, 0, 0);
		draw_canvas(canvas);
		loaded = true;
		for (i in load_buffer) {
			draw_remote(load_buffer[i]);
		}


	};
	
	update_quota();
	setInterval(quota_loop, quota_interval);
	
	
}

</script>
</head>
<body style="padding:0;margin:0;">
<div width="100%" style="background:white;position:relative;">
<div style="overflow: hidden; height: 0">
<textarea id="main_text_input" style="outline: none" maxlength="300"></textarea>
<input type="file" id="imageLoader" name="imageLoader"/>
</div>
<div id="vote" style="position:absolute;top:50px;left:10px;text-align:center;width:100px;">
	<button onclick="cast_vote(-1);">don't</button>
	<button onclick="cast_vote(1);">clear</button>
</div>
<div id="alert_div_container" style=""><div id="alert_div" style="">Loading...</div></div>
<div id="corner" style="">
<a href="http://www.reddit.com/r/BwastiDraw/" target="_blank">
<img src="http://f.thumbs.redditmedia.com/JwH8ypKeMDoptkyG.png"/></a><br>
<span id="user_count"># of</span> users

</div>
<canvas id="main_canvas" height="100%" width="100%"></canvas>
</div>
<div id="chat" class="chat_shown">
<div id="chat_header" style="" onclick="toggle_chat()">
    <div style="float:left">
        Chat
    </div>
    <div style="float:right">
        <span id="chat_toggle"><img class="chat_button" src="static/images/draw/close_chat.png"/></span>
    </div>
</div>
<div class="body" id="chat_body">
</div>
<textarea class="input" id="chat_input">
</textarea>
</div>
<div class="minimap">
<canvas id="mini_canvas"></canvas>
</div>
<div id="colorwheel"><input type="color" name="favcolor" id="colorselect"><button onclick='choose_custom_color()'>select</button></div>
<img id="sprite" src="http://png-3.findicons.com/files/icons/2141/web_design_creatives/128/circle.png" style="width:20px;position:absolute;top:0;left:0; display:none;"/>
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-42573666-1', 'bwasti.com');
  ga('send', 'pageview');

</script>
</body>
</html>
